sudo: required # needed for trusty beta
dist: trusty   # needed for HarfBuzz

language: c

compiler:
  - clang
  - gcc

before_script:
  - sudo add-apt-repository -y ppa:as-bahanta/raqm
  - sudo add-apt-repository -y ppa:dns/gnu
  - sudo add-apt-repository -y ppa:aacid/openjp2trusty
  - #sudo add-apt-repository -y ppa:opencpu/julia
  - #sudo add-apt-repository -y ppa:tuxpoldo/yeasoft-backports
  - sudo add-apt-repository -y ppa:richardpuppy96/backports
  - sudo add-apt-repository -y ppa:twodopeshaggy/ppapackages
  - #sudo add-apt-repository -y ppa:voxops/backports
  - #sudo add-apt-repository -y ppa:dsci-admins/live
  - sudo apt-key update -q
  - sudo apt-get update -q
  - sudo apt-get install --only-upgrade autoconf
  - sudo apt-get install -y libgs-dev libfftw3-dev fonts-dejavu fonts-dejavu-extra fonts-dejavu-core libpotrace-dev libraqm-dev libfreetype6-dev libharfbuzz-dev libfribidi-dev libperl-dev graphviz-dev libgraphviz-dev libwmf-dev fftw-dev libraw-dev libopenraw-dev liblqr-1-0-dev libopenjpeg-dev libopenjp2-7-dev libpango1.0-dev libwebp-dev  # autotrace-dev flif-dev?
  - #sudo apt-get install -y libpotrace-dev libraqm-dev libfreetype6-dev libharfbuzz-dev libfribidi-dev libperl-dev graphviz-dev libgraphviz-dev libwmf-dev fftw-dev libraw-dev libopenraw-dev liblqr-1-0-dev libopenjpeg-dev libopenjp2-7-dev libpango1.0-dev libwebp-dev

script:
  - #dpkg -l | grep    "^ii  lib[a-f]" ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  lib[g-k]" ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  lib[l-q]" ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  lib[r-z]" ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  [a-f]"    ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  [g-h]"    ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  [i-k]"    ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  l[a-j]"   ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  li[^b]"   ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  l[k-z]"   ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^ii  [k-z]"    ; sleep 1   # Check to see what's there...
  - #dpkg -l | grep    "^rc  "         ; sleep 1   # Check to see what's there...
  - dpkg -l | grep    "^ii  " | wc -l ; sleep 1   # How many packages have we installed?
  - export OMP_NUM_THREADS=1
  - export CFLAGS="-Wno-deprecated-declarations -Wdeclaration-after-statement -Wno-error=unused-variable"
  - ./configure --with-rsvg --with-wmf --with-autotrace --with-x --enable-reproducible-build --enable-hdri --with-gvc --with-fpx --with-heic --with-raqm --with-gslib --with-perl --with-dejavu-font-dir=/usr/share/fonts/truetype/dejavu --prefix=/usr
  - make -j$(nproc)
  - # Generate AppImage
  - mkdir -p appdir/usr/share/applications/ ; cp appimage/imagemagick.desktop appdir/usr/share/applications/
  - mkdir -p appdir/usr/share/icons/hicolor/512x512/apps/ ; cp appimage/imagemagick.png  appdir/usr/share/icons/hicolor/512x512/apps/
  - make install DESTDIR=$(readlink -f appdir) ; find appdir/
  - cd appdir/usr/lib/ImageMagick-7.0.7/config-Q16HDRI ; ln -s ../../../etc/ImageMagick-7/*.xml . ; cd -
  - cd appdir/usr/lib/ImageMagick-7.0.7/config-Q16HDRI ; ln -s ../../../share/ImageMagick-7/*.xml . ; cd -
  - wget -c "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
  - chmod a+x linuxdeployqt*.AppImage
  - unset QTDIR; unset QT_PLUGIN_PATH ; unset LD_LIBRARY_PATH
  - export VERSION=$(git rev-parse --short HEAD)-$CC
  - ./linuxdeployqt*.AppImage ./appdir/usr/share/applications/imagemagick.desktop -bundle-non-qt-libs
  - ./linuxdeployqt*.AppImage --appimage-extract
  - ls -1d */
  - rm ./appdir/AppRun ; cp appimage/AppRun appdir/ ; chmod a+x ./appdir/AppRun # Replace symlink with custom script
  - PATH=./squashfs-root/usr/bin:$PATH ./squashfs-root/usr/bin/appimagetool -g ./appdir/
  - find ./appdir -executable -type f -exec ldd {} \; | grep " => /usr" | cut -d " " -f 2-3 | sort | uniq
  - mv ./ImageMagick*.AppImage ./ImageMagick-xperimental.AppImage
  - if [ "$TRAVIS_BRANCH" == "TRAVIS_TAG" ] ; then wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh ; bash upload.sh ImageMagick*AppImage* ; fi
  - #if [ "$TRAVIS_BRANCH" != "TRAVIS_TAG" ] ; then 
  - curl --upload-file ./ImageMagick*.AppImage https://transfer.sh/ImageMagick-xperimental-x86_64.AppImage
  - #; fi

after_success:
